<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Informe SonarQube - {{ project_key }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light">
  <style>
    /* Sonar-like design tokens */
    :root{
      --primary: #2b5f8a;        /* blue used before */
      --accent: #5b6ac4;         /* tab/active color */
      --muted: #8a90a6;
      --bg: #f7f8fb;
      --card-bg: #ffffff;
      --border: #e6e9f0;
      --danger: #d9534f;
      --danger-strong: #8b0000;
      --success: #28a745;
      --shadow: 0 6px 18px rgba(41,50,60,0.06);
      --radius: 10px;
      --pill-bg: #eef3ff;
      --pill-color: #485f9a;
      --small: 0.85rem;
      font-family: Inter, "Helvetica Neue", Arial, sans-serif;
      color-scheme: light;
    }

    html,body { height:100%; margin:0; background:var(--bg); color:#222; }
    a { color:var(--primary); text-decoration:none; }
    a:hover { text-decoration:underline; }

    /* Top navigation */
    .topbar {
      background:#fff;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      padding:12px 20px;
      gap:18px;
      position:sticky;
      top:0;
      z-index:30;
    }
    .nav-tabs { display:flex; gap:18px; align-items:center; }
    .nav-tabs .tab {
      padding:10px 14px;
      border-radius:6px 6px 0 0;
      color:#444;
      font-weight:600;
      font-size:0.95rem;
    }
    .nav-tabs .tab.active {
      background:linear-gradient(180deg, rgba(88,108,184,0.06), transparent);
      color:var(--accent);
      box-shadow:inset 0 -2px 0 var(--accent);
    }
    .top-actions { margin-left:auto; display:flex; gap:14px; align-items:center; color:var(--muted); font-size:0.95rem; }

    /* Layout */
    .page { max-width:1200px; margin:18px auto; display:grid; grid-template-columns:280px 1fr; gap:18px; align-items:start; }
    .sidebar { background:var(--card-bg); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); height:fit-content; }
    .main { display:flex; flex-direction:column; gap:14px; }

    /* Quality gate block */
    .qgate {
      display:flex; gap:12px; align-items:center; padding:12px; border-radius:8px; background:#fff;
      border:1px solid #f3d6d6;
    }
    .qgate .icon {
      width:56px; height:56px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:#fdecec; color:var(--danger-strong); font-weight:700; font-size:1.2rem;
    }
    .qgate .info { font-weight:700; color:#2e3b4d; }
    .qgate .sub { color:var(--muted); font-size:0.9rem; margin-top:6px; }

    /* Card grid similar to Sonar */
    .cards { display:grid; grid-template-columns:repeat(2,1fr); gap:14px; }
    .card { background:var(--card-bg); border:1px solid var(--border); padding:18px; border-radius:12px; box-shadow:var(--shadow); }
    .card .title { font-size:0.95rem; color:#3b4a63; font-weight:700; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; }
    .metric-big { font-size:1.9rem; font-weight:800; color:#1f2a44; }
    .metric-note { color:var(--muted); margin-top:6px; font-size:0.9rem; }

    /* badge/pill */
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:0.8rem; color:var(--pill-color); background:var(--pill-bg); border:1px solid rgba(74,102,173,0.06); }

    /* Issue list - like Sonar issue cards */
    .issues-top { display:flex; gap:12px; align-items:center; margin-bottom:10px; }
    .issues-list { display:flex; flex-direction:column; gap:12px; }
    .issue-card {
      border-radius:10px; background:var(--card-bg); border:1px solid #e7e9f2; padding:14px; display:flex; gap:12px; align-items:flex-start;
      transition:box-shadow .15s ease, transform .12s ease;
    }
    .issue-card:hover { box-shadow:0 8px 20px rgba(50,60,80,0.06); transform:translateY(-2px); }
    .issue-left { width:48px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .issue-checkbox { width:18px; height:18px; border:1px solid #cfd6ea; border-radius:4px; cursor:pointer; }
    .issue-body { flex:1; }
    .issue-title { font-weight:700; color:var(--accent); font-size:1rem; margin:0 0 6px 0; }
    .issue-desc { color:var(--muted); margin-bottom:8px; font-size:0.95rem; }
    .issue-meta { display:flex; justify-content:space-between; align-items:center; gap:12px; color:var(--muted); font-size:0.9rem; }
    .severity-pill { padding:6px 10px; border-radius:999px; font-weight:700; font-size:0.82rem; color:#fff; }
    .sev-BLOCKER { background:#7f0000; }
    .sev-CRITICAL { background:#d9534f; }
    .sev-MAJOR { background:#ea6d54; }
    .sev-MINOR { background:#f0ad4e; color:#222; }
    .sev-INFO { background:#5bc0de; color:#fff; }

    .issue-tags { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .tag { padding:6px 8px; font-size:0.82rem; border-radius:6px; background:#f5f7fb; color:#55607a; border:1px solid #eef3ff; }

    /* Left counts */
    .left-stats { margin-top:14px; display:flex; flex-direction:column; gap:8px; }
    .left-stat { display:flex; justify-content:space-between; color:#394a6a; font-weight:700; font-size:0.95rem; padding:8px 0; border-bottom:1px dashed #f3f4f8; }
    .left-stat small { display:block; font-size:0.85rem; color:var(--muted); font-weight:500; margin-top:4px; }

    /* small utilities */
    .search-row { display:flex; gap:8px; align-items:center; }
    .search { flex:1; padding:9px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; }
    .select-all { display:flex; gap:8px; align-items:center; color:var(--muted); }

    @media (max-width:980px){
      .page { grid-template-columns:1fr; padding:12px; }
      .cards { grid-template-columns:1fr; }
      .sidebar { order:2; }
    }
  </style>
</head>
<body>
  <div class="topbar" role="navigation" aria-label="Top navigation">
    <div class="nav-tabs" role="tablist" aria-label="Project tabs">
      <div class="tab active" role="tab">Overview</div>
      <div class="tab" role="tab">Issues</div>
      <div class="tab" role="tab">Security Hotspots</div>
      <div class="tab" role="tab">Measures</div>
      <div class="tab" role="tab">Code</div>
      <div class="tab" role="tab">Activity</div>
    </div>

    <div class="top-actions">
      <div class="small">Project: <strong>{{ project_key }}</strong></div>
      <div class="small">Source: <a href="{{ sonar_url }}/dashboard?id={{ project_key }}">{{ sonar_url }}</a></div>
    </div>
  </div>

  <div class="page" role="main">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Sidebar">
      <div style="display:flex; flex-direction:column; gap:12px;">
        <div class="qgate" aria-live="polite">
          <div class="icon">✕</div>
          <div>
            <div class="info">Failed</div>
            <div class="sub">{{ quality_gate_failed_conditions or "0 failed conditions" }}</div>
          </div>
        </div>

        <div class="left-stats" aria-hidden="false">
          <div>
            <div style="font-size:0.9rem;color:var(--muted);">New Issues</div>
            <div style="font-weight:800;font-size:1.15rem">{{ measures.get('new_issues', '—') }}</div>
          </div>
          <div>
            <div style="font-size:0.9rem;color:var(--muted);">Duplicated lines</div>
            <div style="font-weight:800;font-size:1.15rem">{{ measures.get('duplicated_lines_density', '—') }}%</div>
          </div>
        </div>

        <div style="border-top:1px solid var(--border); padding-top:12px;">
          <div style="font-weight:700; color:#3b4a63; margin-bottom:8px;">Quality Gate</div>
          <div class="small">Fix issues before they fail your Quality Gate. More details at <a href="{{ sonar_url }}/dashboard?id={{ project_key }}">SonarQube</a>.</div>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <section class="main">
      <!-- Top metrics cards -->
      <div class="cards" aria-label="Overview cards">
        <div class="card">
          <div class="title"><span>New issues <span class="badge">FAILED</span></span><span class="small">Required = 0</span></div>
          <div style="display:flex; align-items:center; gap:18px;">
            <div style="flex:1;">
              <div class="metric-big">{{ measures.get('bugs', measures.get('new_bugs', '—')) }}</div>
              <div class="metric-note">New issues total</div>
            </div>
            <div style="width:90px; text-align:center;">
              <div class="badge" title="Accepted issues">Accepted</div>
              <div style="font-weight:800; font-size:1.1rem; margin-top:10px;">{{ measures.get('accepted_issues', 0) }}</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="title"><span>Coverage <span class="badge">FAILED</span></span><span class="small">Required ≥ 80.0%</span></div>
          <div style="display:flex; align-items:center; gap:18px;">
            <div style="flex:1;">
              <div class="metric-big">{{ measures.get('coverage', '0.0') }}%</div>
              <div class="metric-note">Coverage on new code</div>
            </div>
            <div style="width:90px; text-align:center;">
              <div style="background:linear-gradient(180deg,#f8f3f4,#fff); border-radius:50%; width:56px; height:56px; display:inline-flex; align-items:center; justify-content:center; color:var(--danger);">%</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="title"><span>Duplications <span class="badge">FAILED</span></span><span class="small">Required ≤ 3.0%</span></div>
          <div style="display:flex; align-items:center; gap:18px;">
            <div style="flex:1;">
              <div class="metric-big">{{ measures.get('duplicated_lines_density', '—') }}%</div>
              <div class="metric-note">Duplicated lines (new code)</div>
            </div>
            <div style="width:90px; text-align:center;">
              <div style="background:linear-gradient(180deg,#f3fff5,#fff); border-radius:50%; width:56px; height:56px; display:inline-flex; align-items:center; justify-content:center; color:var(--success);">●</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="title"><span>Security Hotspots <span class="badge">FAILED</span></span><span class="small">Review required</span></div>
          <div style="display:flex; align-items:center; gap:18px;">
            <div style="flex:1;">
              <div class="metric-big">{{ measures.get('security_hotspots', measures.get('security_hotspots_count', 0)) }}</div>
              <div class="metric-note">Potential security issues to review</div>
            </div>
            <div style="width:90px; text-align:center;">
              <div class="badge" style="background:#fff3f3;border:1px solid #f8e7e7;color:var(--danger-strong);">!</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Analyses list -->
      <div class="card" style="padding-bottom:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:800; color:#31405a;">Últimos análisis</div>
          <div class="small">{{ analyses|length }} análisis</div>
        </div>

        <ul style="margin-top:12px; padding-left:18px; color:var(--muted);">
          {% for a in analyses %}
            <li style="margin:6px 0;">{{ a.date }} — id: {{ a.key }}</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Issues area with header controls -->
      <div class="card" style="padding-bottom:12px;">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div style="display:flex; align-items:center; gap:12px;">
            <div style="font-weight:800; color:#31405a;">Issues</div>
            <div class="small" style="color:var(--muted)">{{ issues|length }} issues (most recent)</div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <div class="search-row" role="search" aria-label="Buscar issues">
              <input class="search" id="searchBox" placeholder="Buscar por mensaje, archivo o tag..." />
            </div>
            <div class="select-all"><label><input type="checkbox" id="selectAll" /> Seleccionar</label></div>
          </div>
        </div>

        <div class="issues-list" id="issuesList" style="margin-top:12px;">
          {% for it in issues %}
            <article class="issue-card" data-title="{{ it.message | e }}" data-file="{{ (it.component.split(':')[-1]) }}" data-severity="{{ it.severity }}">
              <div class="issue-left">
                <div class="issue-checkbox" role="checkbox" aria-checked="false" tabindex="0"></div>
              </div>

              <div class="issue-body">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                  <h3 class="issue-title">
                    <a href="{{ sonar_url }}/project/issues?id={{ project_key }}&open={{ it.key or '' }}" target="_blank">{{ it.message | e }}</a>
                  </h3>
                  <div>
                    <span class="severity-pill sev-{{ it.severity }}">{{ it.severity }}</span>
                  </div>
                </div>

                <div class="issue-desc">
                  Archivo: <strong>{{ (it.component.split(':')[-1]) }}</strong> — Tipo: <em>{{ it.type }}</em> en <strong> línea:{{ it.line or 'N/A' }}</strong>
                  <div class="issue-tags">
                    {% for t in (it.tags or []) %}
                      <span class="tag">{{ t }}</span>
                    {% endfor %}
                  </div>
                </div>

                <div class="issue-meta">
                  <div>
                    <small>{{ it.createdAt or it.date or '' }} • {{ it.effort or '' }}</small>
                  </div>
                  <div style="color:var(--muted)">
                    <small><a href="{{ sonar_url }}/project/issues?id={{ project_key }}&open={{ it.key or '' }}" target="_blank">Ir a SonarQube</a></small>
                  </div>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </div>
    </section>

  </div>

  <script>
    // Small interactive helpers: search, select all, checkbox toggle
    (function(){
      const search = document.getElementById('searchBox');
      const issues = Array.from(document.querySelectorAll('.issue-card'));
      const selectAll = document.getElementById('selectAll');

      function filterIssues(q){
        q = (q||'').trim().toLowerCase();
        issues.forEach(card=>{
          const title = card.dataset.title.toLowerCase();
          const file = (card.dataset.file||'').toLowerCase();
          const sev = (card.dataset.severity||'').toLowerCase();
          if(!q || title.includes(q) || file.includes(q) || sev.includes(q)){
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      }

      search && search.addEventListener('input', (e)=> filterIssues(e.target.value));

      // checkbox toggles
      document.querySelectorAll('.issue-checkbox').forEach(cb=>{
        cb.addEventListener('click', ()=> {
          const checked = cb.classList.toggle('checked');
          cb.setAttribute('aria-checked', checked ? 'true' : 'false');
          cb.style.background = checked ? 'linear-gradient(180deg, rgba(43,95,138,0.12), rgba(43,95,138,0.06))' : '';
          cb.style.borderColor = checked ? 'var(--accent)' : '#cfd6ea';
        });
        cb.addEventListener('keypress', (ev)=> { if(ev.key === 'Enter') cb.click(); });
      });

      selectAll && selectAll.addEventListener('change', (e)=>{
        const on = e.target.checked;
        document.querySelectorAll('.issue-checkbox').forEach(cb=>{
          if(on && !cb.classList.contains('checked')) cb.click();
          if(!on && cb.classList.contains('checked')) cb.click();
        });
      });

      // accessible keyboard for searching (press / to focus)
      window.addEventListener('keydown', (ev)=> {
        if(ev.key === '/') {
          ev.preventDefault();
          search && search.focus();
        }
      });
    })();
  </script>
</body>
</html>